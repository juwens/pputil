name: Push at Main

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: macos-15

    steps:
    - uses: actions/checkout@v4
    - uses: Swatinem/rust-cache@v2
    - name: Build
      run: cargo build --release # --verbose
    - name: TarGz Release
      run: tar -czvf target/release/pputil.tar.gz -C target/release pputil
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        path: |
          target/release/pputil.tar.gz
          target/release/pputil
    - name: Run tests
      run: cargo test --release # --verbose
    - name: extract version from cargo.toml
      id: version
      run: |
        echo "$GITHUB_OUTPUT"
        echo "cargo_version=v$(yq .package.version Cargo.toml)" >> $GITHUB_OUTPUT
    - name: echo version in shell
      run: |
        cat  "$GITHUB_OUTPUT"
    - name: echo verion in js
      run: |
        console.log(steps.version.outputs.cargo_version)
        console.log(${{ steps.version.outputs.cargo_version }})
        console.log(JSON.stringify(steps.version.outputs))
        console.log(context)
    - name: Create tag
      uses: actions/github-script@v5
      with:
        script: |
          github.rest.git.createRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: 'refs/tags/${{ steps.version.outputs.cargo_version }}',
            sha: context.sha
          })
     # sadly, action "rust-build/rust-build.action" is only supported on linux runners
    - name: release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        VERSION="v$(yq .package.version Cargo.toml)"
        gh api \
          --method POST \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          /repos/juwens/pputil/git/tags \
          -f "tag=$VERSION" \
          -f "message=release $VERSION"  \
          -f "object=$(git rev-parse --verify HEAD)"  \
          -f "type=commit" \
          -f "tagger[name]=pputil bot"  \
          -f "tagger[email]=noreply@github.com"  \
          -f "tagger[date]=$(date -Iseconds)"
        curl -sL --fail-with-body \
          -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/juwens/pputil/releases \
          -d "$(jq -n --arg version "$VERSION" '{"tag_name":$version,"target_commitish":"master","name":$version,"body":"Release of version $version","draft":false,"prerelease":false,"generate_release_notes":false}')"
